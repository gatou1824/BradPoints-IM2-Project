<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <script>
    // Run this before loading the full page content
    const token = localStorage.getItem('token');

    if (!token) {
      alert('No token found. Redirecting...');
      window.location.href = '/';
    }

    // Immediately check the role
    fetch('/profile', {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error('Unauthorized');
      return res.json();
    })
    .catch(err => {
      alert('Access denied or token invalid. Redirecting...');
      window.location.href = '/';
    });

    // On load
    fetch('/rewards/progress', {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
      const section = document.getElementById('rewards-section');
      if (!section) return;

      data.forEach(r => {
        const div = document.createElement('div');
        div.id = `reward-${r.reward_id}`;  // Inside .forEach loop of /rewards/progress
        div.style.border = '1px solid #ccc';
        div.style.margin = '10px 0';
        div.style.padding = '10px';
        const savedCode = localStorage.getItem(`reward-${r.reward_id}`);
        if (savedCode) {
          div.innerHTML = `
            <p><strong>${r.reward_name} (${r.food_name})</strong></p>
            <p><strong>Code:</strong> ${savedCode}</p>
            <p>This code expires in 24 hours. Show this to the cashier upon ordering.</p>
          `;
        } else {
          div.innerHTML = `
            <p><strong>${r.reward_name} (${r.food_name})</strong></p>
            <p>Progress: ${r.progress} / ${r.required_points}</p>
            ${
              r.claimed_recently
                ? `<p style="color: green;">Already claimed (expires within 24 hours)</p>`
                : r.can_claim
                ? `<button onclick="claimReward(${r.reward_id})">Claim</button>`
                : `<p style="color: gray;">Not enough points yet</p>`
            }
          `;
        }


        section.appendChild(div);
      });
    });

function claimReward(id) {
  fetch(`/rewards/claim/${id}`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(err => {
        throw new Error(err.message || 'Failed to claim');
      });
    }
    return res.json();
  })
  .then(data => {
    const rewardContainer = document.querySelector(`#reward-${id}`);
    if (!rewardContainer) return;

    rewardContainer.innerHTML = `
      <p><strong>Code:</strong> ${data.code}</p>
      <p>This code expires in 24 hours. Show this to the cashier upon ordering.</p>
    `;
    localStorage.setItem(`reward-${id}`, data.code); // 🔐 Save to localStorage

  })
  .catch(err => {
    alert(err.message);
    console.error(err);
  });
}


  </script>
</head>
<body>
  <h1>Welcome to the Customer Dashboard!</h1>
  <p id="tokenDisplay"></p>

  <div>
    <button onclick="profile()">Profile</button>
    <div id="toggle-profile" style="display: none;"></div>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- ✅ Feedback prompt appears first -->
  <div id="feedbackPrompt" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 20px;">
    <p id="feedbackText"></p>
    <button onclick="giveFeedback()">Yes</button>
    <button onclick="dismissFeedback()">No</button>
  </div>

  <!-- ✅ Hidden feedback form appears if Yes is clicked -->
  <div id="send-feedback" style="display: none;">
    <h2>Send Feedback</h2>
    <form id="feedbackForm">
      <textarea id="feedbackMessage" rows="4" cols="50" placeholder="Enter your feedback..." required></textarea><br>
      <button onclick="submitFeedback()" type="submit">Submit</button>
    </form>
    <p id="feedbackStatus"></p>
  </div>

  <div id="rewards-section">
    <h2>Available Rewards</h2>
  </div>

  <script>
    const toggleProfile = document.getElementById('toggle-profile');
    let profileVisible = false;
    let currentOrderId = null;
    let activeOrderId = null;

    document.getElementById('tokenDisplay').textContent = `Your token: ${token}`;

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/';
    }

    function profile() {
      if (!profileVisible) {
        fetch('/profile', {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${token}`
          }
        })
        .then(res => {
          if (!res.ok) throw new Error('Unauthorized');
          return res.json();
        })
        .then(data => {
          toggleProfile.innerHTML = `
            <p>Username: ${data.username}</p>
            <p>Email: ${data.email}</p>
            <p>Role: ${data.role}</p>
            <p>Points: ${data.points}</p>
            <p>Code: ${data.user_code}</p>
          `;
          toggleProfile.style.display = 'block';
          profileVisible = true;
        })
        .catch(err => {
          alert('Token invalid or expired. Redirecting...');
          window.location.href = '/';
        });
      } else {
        toggleProfile.style.display = 'none';
        profileVisible = false;
      }
    }

document.getElementById('feedbackForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const message = document.getElementById('feedbackMessage').value;

  fetch('/feedback/sendFeedback', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ order_id: activeOrderId, message })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('feedbackStatus').textContent = data.message;
    document.getElementById('feedbackMessage').value = '';
    document.getElementById('send-feedback').style.display = 'none';
    activeOrderId = null;
  })
  .catch(err => {
    document.getElementById('feedbackStatus').textContent = 'Failed to send feedback.';
    console.error(err);
  });
});


function checkForRecentOrders() {
  fetch('/orders/pending-feedback', {
    method: 'GET',
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    if (Array.isArray(data) && data.length > 0) {
      data.forEach(order => {
        renderFeedbackPrompt(order.id, order.created_at);
      });
    }
  });
}

function giveFeedback() {
  document.getElementById('feedbackPrompt').style.display = 'none';
  document.getElementById('send-feedback').style.display = 'block';
}

function showFeedbackForm(orderId, btn) {
  activeOrderId = orderId;
  document.getElementById('send-feedback').style.display = 'block';
  btn.parentElement.style.display = 'none'; // hide prompt
}

function dismissFeedbackPrompt(btn) {
  btn.parentElement.style.display = 'none'; // hide prompt
}

function submitFeedback() {
  document.getElementById('feedbackForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const message = document.getElementById('feedbackMessage').value;

  fetch('/feedback/sendFeedback', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ message, order_id: currentOrderId }) // 🟢 include order ID
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('feedbackStatus').textContent = data.message;
    document.getElementById('feedbackMessage').value = '';
    document.getElementById('send-feedback').style.display = 'none';
    alert('Send Feedback successfully!');
    currentOrderId = null;
  })
  .catch(err => {
    document.getElementById('feedbackStatus').textContent = 'Failed to send feedback.';
    console.error(err);
  });
  });
}

function renderFeedbackPrompt(orderId, orderDate) {
  const container = document.createElement('div');
  container.style.border = '1px solid #ccc';
  container.style.padding = '10px';
  container.style.marginTop = '10px';

  container.innerHTML = `
    <p>You ordered from us on ${new Date(orderDate).toLocaleString()} — Give feedback?</p>
    <button onclick="showFeedbackForm(${orderId}, this)">Yes</button>
    <button onclick="dismissFeedbackPrompt(this)">No</button>
  `;

  document.body.appendChild(container);
}



checkForRecentOrders();
  </script>
</body>
</html>
