<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #ffffff;
      color: #333;
    }

    header {
      background-color: white; /* changed from red */
      border-bottom: 4px solid #b91c1c; /* red bottom border */
      padding: 20px 330px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header img {
      height: 70px; /* üëà limits the logo height */
      object-fit: contain;
    }


    .profile-container {
      position: relative;
      margin-left: 15px;
    }

    .profile-icon {
      width: 70px;
      height: 70px;
      background-color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b91c1c;
      font-weight: bold;
      cursor: pointer;
      font-size: 32px; /* üëà this makes the emoji grow */
    }


    .dropdown {
      position: absolute;
      right: 0;
      top: 45px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: none;
      flex-direction: column;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      min-width: 140px; /* üëà ensures enough space */
      white-space: nowrap; /* üëà prevents text wrapping */
      z-index: 1000;
    }

    .dropdown a {
      padding: 10px 15px;
      color: #b91c1c;
      text-decoration: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      display: block;
    }

    .dropdown a:last-child {
      border-bottom: none;
    }

    .dropdown a:hover {
      background-color: #ffeaea;
    }
    #toggle-profile {
      position: fixed;
      top: 134px;
      right: 10px;
      width: 315px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 16px;
      overflow: visible; /* allow avatar to overflow */
      z-index: 999;
      display: none;
      font-family: Arial, sans-serif;
      padding-top: 75px; /* üëà add this to make room for avatar */
    }

    .profile-header {
      background-color: #b91c1c;
      color: white;
      text-align: center;
      padding: 40px 20px 20px;
      position: relative;
    }

    .profile-avatar {
      width: 100px; /* ‚¨Ü bigger */
      height: 100px; /* ‚¨Ü bigger */
      font-size: 42px; /* ‚¨Ü bigger emoji */
      top: -50px; /* adjust for larger size */
      border-radius: 50%;
      background-color: #e5e7eb;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #374151;
    }

    .profile-header h2 {
      margin: 10px 0 0;
      font-size: 20px;
    }

    .profile-header span {
      font-size: 13px;
      opacity: 0.9;
    }

    .profile-body {
      padding: 20px;
      font-size: 14px;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 14px;
      padding: 0 10px;
    }

    .profile-label {
      color: #555;
    }

    .profile-value {
      font-weight: bold;
    }

.tab-buttons {
  display: flex; /* changed from inline-flex */
  border: 2px solid #b91c1c;
  border-radius: 9999px;
  overflow: hidden;
  background-color: #b91c1c;
}

    .tab-buttons button {
      background-color: #b91c1c;
      color: white;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .tab-buttons button.active {
      background-color: white;
      color: #b91c1c;
      font-weight: bold;
    }

    .reward-card {
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .reward-info {
      max-width: 70%;
    }

    .reward-actions {
      margin-left: auto;
    }

    #send-feedback h2 {
  color: #b91c1c;
  margin-bottom: 10px;
  text-align: center;
}

#feedbackForm {
  text-align: center;
}

#feedbackMessage {
  width: 100%;
  max-width: 500px;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  resize: vertical;
  font-size: 14px;
}

#feedbackForm button {
  padding: 10px 20px;
  margin: 10px 5px 0;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
}

#feedbackForm button[type="submit"] {
  background-color: #b91c1c;
  color: white;
}

#cancelFeedbackBtn {
  background-color: #e5e7eb;
  color: #333;
}

.star {
  font-size: 32px;
  color: gray;
  cursor: pointer;
  transition: transform 0.2s;
  margin: 0 3px;
}

.star:hover {
  transform: scale(1.2);
}

.star.selected {
  color: gold;
}

.notification-card {
  display: flex;
  align-items: flex-start;
  background: #f8fafc;
  border-left: 5px solid #fbbf24; /* gold */
  border-radius: 10px;
  margin-bottom: 16px;
  padding: 16px 20px 16px 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
  transition: box-shadow 0.2s;
  position: relative;
}

.notification-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  background: #fffbe7;
}

.notification-icon {
  font-size: 28px;
  margin-right: 16px;
  color: #f59e42;
  flex-shrink: 0;
  margin-top: 2px;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: bold;
  color: #b91c1c;
  margin-bottom: 2px;
}

.notification-message {
  color: #333;
  margin-bottom: 4px;
}

.notification-time {
  font-size: 12px;
  color: #888;
  margin-top: 2px;
}

.reward-card {
  display: flex;
  align-items: flex-start;
  background: #f8fafc;
  border-left: 5px solid #38bdf8; /* sky blue */
  border-radius: 10px;
  margin-bottom: 18px;
  padding: 18px 22px 18px 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
  transition: box-shadow 0.2s, background 0.2s;
  position: relative;
}

.reward-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  background: #e0f2fe;
}

.reward-icon {
  font-size: 32px;
  margin-right: 18px;
  color: #0ea5e9;
  flex-shrink: 0;
  margin-top: 2px;
}

.reward-info {
  flex: 1;
}

.reward-title {
  font-weight: bold;
  color: #0ea5e9;
  font-size: 18px;
  margin-bottom: 2px;
}

.reward-desc {
  color: #333;
  margin-bottom: 6px;
}

.reward-progress {
  font-size: 14px;
  color: #64748b;
  margin-bottom: 4px;
}

.reward-actions {
  display: flex;
  align-items: center;
  margin-left: 24px;
  min-width: 140px; /* Reserve space for button or message */
  max-width: 180px;
  justify-content: flex-end;
}

.reward-actions button {
  padding: 8px 18px;
  background-color: #0ea5e9;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  margin-right: 8px;
  transition: background 0.2s;
}

.reward-actions button:disabled,
.reward-actions .disabled {
  background: #e5e7eb;
  color: #888;
  cursor: not-allowed;
}

.reward-actions p {
  margin: 0;
  font-size: 14px;
}

.reward-actions:empty {
  min-width: 140px;
  max-width: 180px;
  /* No border, no background */
}

  </style>
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('No token found. Redirecting...');
      window.location.href = '/';
    }

fetch('/rewards/progress', {
  headers: { Authorization: `Bearer ${token}` }
})
.then(res => res.json())
.then(data => {
  const rewardsContainer = document.getElementById('rewards');
  rewardsContainer.innerHTML = ''; // clear previous entries
  if (!Array.isArray(data)) {
    console.error('Expected array, got:', data);
    return;
  } 
data.forEach(r => {
  const div = document.createElement('div');
  div.className = 'reward-card';

  // Icon
  const icon = document.createElement('div');
  icon.className = 'reward-icon';
  icon.textContent = 'üéÅ';

  // Info
  const info = document.createElement('div');
  info.className = 'reward-info';

  // Title and description
  info.innerHTML = `<div class="reward-title">${r.reward_name}</div>`;
  info.innerHTML += `<div class="reward-desc">${r.progress} / ${r.required_points} points</div>`;

  // Progress or code
  if (r.redeemed) {
    info.innerHTML += `<div class="reward-progress" style="color:green;">‚úÖ Reward already used</div>`;
  } else if (r.code) {
    info.innerHTML += `
      <div class="reward-progress"><span style="color:#0ea5e9;">Code:</span> <b>${r.code}</b></div>
      <div class="reward-progress"><small>This code expires in 24 hours. Show this to the cashier upon ordering.</small></div>
    `;
  } else if (r.claimed_recently) {
    info.innerHTML += `<div class="reward-progress" style="color:green;">Already claimed</div>`;
  }

  // Actions
  const actions = document.createElement('div');
  actions.className = 'reward-actions';

  if (!r.redeemed && !r.code && !r.claimed_recently) {
    if (r.can_claim) {
      const btn = document.createElement('button');
      btn.textContent = 'Redeem';
      btn.onclick = () => claimReward(r.reward_id, btn);
      actions.appendChild(btn);
    } else {
      const p = document.createElement('p');
      p.className = 'disabled';
      p.textContent = 'Not enough points yet';
      actions.appendChild(p);
    }
  }

  div.appendChild(icon);
  div.appendChild(info);
  div.appendChild(actions);
  rewardsContainer.appendChild(div);
});
})
.catch(err => {
  console.error('Failed to load rewards:', err);
});



document.addEventListener('DOMContentLoaded', () => {
  const profileDropdown = document.getElementById('profileDropdown');
  const profileIcon = document.getElementById('profileIcon');
  const toggleProfile = document.getElementById('toggle-profile');

  profileIcon.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleProfile.style.display = 'none';
    profileVisible = false;
    profileDropdown.style.display = profileDropdown.style.display === 'flex' ? 'none' : 'flex';
  });

  document.addEventListener('click', (e) => {
    // Close dropdown if click is outside of profileIcon and profileDropdown
    if (!profileDropdown.contains(e.target) && !profileIcon.contains(e.target)) {
      profileDropdown.style.display = 'none';
    }

    // Close toggle-profile if click is outside
    if (!toggleProfile.contains(e.target) && !profileIcon.contains(e.target)) {
      toggleProfile.style.display = 'none';
    }
  });
});

  </script>
</head>
<body>
  <header>
    <img src="/images/logo.jpg" alt="">
    <div class="profile-container">
      <div class="profile-icon" id="profileIcon">üë§</div>
      <div class="dropdown" id="profileDropdown">
        <a href="#" onclick="profile()">View Profile</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </header>

  <div id="toggle-profile"></div>

  <main style="padding: 20px; max-width: 1210px; margin: 0 auto;">

  <div id="points-section" style="text-align:center; background-color: #fde8e8; padding: 40px 20px;">
    <div id="points-circle" style="width: 120px; height: 120px; border: 2px solid #b91c1c; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 36px; color: #b91c1c;">
      <!-- Points will be inserted here -->
    </div>
    <div id="user-code" style="background-color: #b91c1c; color: white; display: inline-block; margin-top: 10px; padding: 6px 16px; border-radius: 9999px; font-weight: bold;">
      <!-- Code goes here -->
    </div>
  </div>

<div style="display: flex; justify-content: center; margin-top: 20px;">
  <div class="tab-buttons">
    <button id="tab-rewards" onclick="showTab('rewards')">Rewards</button>
    <button id="tab-notifications" onclick="showTab('notifications')">Notifications</button>
    <button id="tab-history" onclick="showTab('history')">History</button>
    <button id="tab-feedback" onclick="showTab('feedback')">Feedback</button>
  </div>
</div>



  <div id="rewards" style="margin-top: 20px;"></div>
  <div id="notifications" style="display:none;"></div>
  <div id="history" style="display:none;"></div>
  <div id="feedback" style="display:none;">
    <div id="send-feedback" style="display: none;">
      <h2>Send Feedback</h2>
      <form id="feedbackForm">
      <div id="starRating" style="margin-bottom: 10px;">
        <i class="bi bi-star star" data-value="1"></i>
        <i class="bi bi-star star" data-value="2"></i>
        <i class="bi bi-star star" data-value="3"></i>
        <i class="bi bi-star star" data-value="4"></i>
        <i class="bi bi-star star" data-value="5"></i>
      </div>

      <textarea id="feedbackMessage" placeholder="Your feedback..."></textarea>

        <button type="submit">Submit</button>
        <button type="button" id="cancelFeedbackBtn" onclick="cancelFeedback()">Cancel</button>
      </form>
      <p id="feedbackStatus"></p>
    </div>
  </div>


  </main>

    <script>
    const toggleProfile = document.getElementById('toggle-profile');
    let currentOrderId = null;
    let activeOrderId = null;

    // Load customer profile (points + code)
fetch('/profile', {
  method: 'GET',
  headers: { Authorization: `Bearer ${token}` }
})
.then(res => res.json())
.then(data => {
  document.getElementById('points-circle').textContent = data.points;
  document.getElementById('user-code').textContent = data.user_code;
})
.catch(err => {
  console.error('Failed to fetch profile:', err);
});

// Claim logic
function claimReward(id, btn) {
  fetch(`/rewards/claim/${id}`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => {
    if (!res.ok) throw new Error('Claim failed');
    return res.json();
  })
  .then(data => {
    const card = btn.closest('.reward-card');
    const info = card.querySelector('.reward-info');
    const actions = card.querySelector('.reward-actions');

    info.innerHTML = `
      <strong>Code:</strong> ${data.code}<br>
      <small>${data.message}</small>
    `;

    actions.innerHTML = ''; // optionally remove buttons
  })
  .catch(err => {
    alert('Error claiming reward.');
    console.error(err);
  });
}

// Tabs
function showTab(tabId) {
  // Reload the page and pass the tabId as a query parameter
  window.location.search = `?tab=${tabId}`;
}

// On page load, check for ?tab= in the URL and show that tab
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const tab = params.get('tab');
  if (tab && ['rewards', 'notifications', 'history', 'feedback'].includes(tab)) {
    ['rewards', 'notifications', 'history', 'feedback'].forEach(id => {
      const el = document.getElementById(id);
      const tabBtn = document.getElementById(`tab-${id}`);
      if (el) el.style.display = (id === tab) ? 'block' : 'none';
      if (tabBtn) tabBtn.classList.toggle('active', id === tab);
    });
    if (tab === 'history') loadHistory();
    if (tab === 'notifications') loadNotifications();
  } else {
    // Default to rewards
    ['rewards', 'notifications', 'history', 'feedback'].forEach(id => {
      const el = document.getElementById(id);
      const tabBtn = document.getElementById(`tab-${id}`);
      if (el) el.style.display = (id === 'rewards') ? 'block' : 'none';
      if (tabBtn) tabBtn.classList.toggle('active', id === 'rewards');
    });
  }
});

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/';
    }

    let profileVisible = false;

    function profile() {
      document.getElementById('profileDropdown').style.display = 'none';
      fetch('/profile', {
        method: 'GET',
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const toggleProfile = document.getElementById('toggle-profile');
        toggleProfile.innerHTML = `
          <div class="profile-header">
            <div class="profile-avatar">üë§</div>
            <h2>${data.username}</h2>
            <span>${data.user_code}</span>
          </div>
          <div class="profile-body">
            <div class="profile-row">
              <span class="profile-label">Email</span>
              <span class="profile-value">${data.email}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Role</span>
              <span class="profile-value">${data.role}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Points</span>
              <span class="profile-value">${data.points}</span>
            </div>
          </div>
        `;
        toggleProfile.style.display = 'block';
        profileVisible = true;
      })
      .catch(() => {
        alert('Token invalid. Redirecting...');
        window.location.href = '/';
      });
    }

function checkForRecentOrders() {
  fetch('/orders/pending-feedback', {
    method: 'GET',
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    if (Array.isArray(data) && data.length > 0) {
      data.reverse().forEach(order => {
        renderFeedbackPrompt(order.id, order.created_at);
      });
    }
  });
}

function giveFeedback() {
  document.getElementById('feedbackPrompt').style.display = 'none';
  document.getElementById('send-feedback').style.display = 'block';
}

function showFeedbackForm(orderId, btn) {
  activeOrderId = orderId;
  document.getElementById('send-feedback').style.display = 'block';

  // ‚¨áÔ∏è This hides the entire prompt container after clicking "Yes"
  const container = btn.closest('.reward-card');
  if (container) container.remove();
}


function dismissFeedbackPrompt(btn) {
  const container = btn.closest('.reward-card');
  const orderId = container.getAttribute('data-order-id');

  fetch(`/feedback/dismissFeedback/${orderId}`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    container.remove(); // ‚úÖ visually remove it
  })
  .catch(err => {
    console.error('Failed to dismiss feedback:', err);
  });
}

let selectedRating = 0;

document.addEventListener('DOMContentLoaded', () => {
const stars = document.querySelectorAll('#starRating .star');

stars.forEach(star => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.getAttribute('data-value'));

    stars.forEach(s => {
      s.classList.remove('selected', 'bi-star-fill');
      s.classList.add('bi-star');
      if (parseInt(s.getAttribute('data-value')) <= selectedRating) {
        s.classList.add('selected', 'bi-star-fill');
        s.classList.remove('bi-star');
      }
    });
  });
});

  // Fix: Submit feedback using activeOrderId and bind listener properly
  document.getElementById('feedbackForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const message = document.getElementById('feedbackMessage').value;

    if (!activeOrderId) {
      alert('No order selected for feedback.');
      return;
    }

    fetch('/feedback/sendFeedback', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ message, order_id: activeOrderId, rating: selectedRating})
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById('feedbackStatus').textContent = data.message;
        document.getElementById('feedbackMessage').value = '';
        document.getElementById('send-feedback').style.display = 'none';
        console.log(message, selectedRating)
        alert('Feedback sent successfully!');
        activeOrderId = null;
        checkForRecentOrders(); // Refresh prompts
      })
      .catch(err => {
        document.getElementById('feedbackStatus').textContent = 'Failed to send feedback.';
        console.error(err);
      });
  });
});

function renderFeedbackPrompt(orderId, orderDate) {
  const container = document.createElement('div');
  container.className = 'reward-card';
  container.setAttribute('data-order-id', orderId); // üü¢ Add this line

  const info = document.createElement('div');
  info.className = 'reward-info';
  info.innerHTML = `
    <strong>Feedback Request</strong><br>
    <span>You ordered from us on ${new Date(orderDate).toLocaleString()} ‚Äî would you like to leave feedback?</span>
  `;

  const actions = document.createElement('div');
  actions.className = 'reward-actions';

  const yesBtn = document.createElement('button');
  yesBtn.textContent = 'Yes';
  yesBtn.style = btnStyle();
  yesBtn.onclick = () => showFeedbackForm(orderId, yesBtn);

  const noBtn = document.createElement('button');
  noBtn.textContent = 'No';
  noBtn.style = btnStyle(true);
  noBtn.onclick = () => dismissFeedbackPrompt(noBtn);

  actions.appendChild(yesBtn);
  actions.appendChild(noBtn);
  container.appendChild(info);
  container.appendChild(actions);
  document.getElementById('feedback').appendChild(container);
}

function btnStyle(isNo = false) {
  return `
    padding: 8px 16px;
    background-color: ${isNo ? '#e5e7eb' : '#b91c1c'};
    color: ${isNo ? '#333' : 'white'};
    border: none;
    border-radius: 5px;
    cursor: pointer;
    ${isNo ? 'margin-left: 10px;' : ''}
  `;
}

function loadHistory() {
  fetch('/rewards/history', {
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    const historyContainer = document.getElementById('history');
    historyContainer.innerHTML = '';

    if (data.length === 0) {
      historyContainer.innerHTML = '<p style="text-align:center;">No transaction history yet.</p>';
      return;
    }

    data.forEach(h => {
      const div = document.createElement('div');
      div.className = 'notification-card';
      let icon = h.type === 'Reward' ? 'üéÅ' : 'üõí';
      let title = h.type === 'Reward' ? 'Reward Redeemed' : 'Order Placed';
      let message = h.type === 'Reward'
        ? `<strong>${h.item}</strong><br><span>Code: ${h.code}</span>`
        : `<strong>${h.item}</strong>`;
      let time = h.type === 'Reward'
        ? `Claimed at: ${new Date(h.date).toLocaleString()}`
        : `Ordered at: ${new Date(h.date).toLocaleString()}`;
      div.innerHTML = `
        <div class="notification-icon">${icon}</div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
          <div class="notification-time">${time}</div>
        </div>
      `;
      historyContainer.appendChild(div);
    });
  })
  .catch(err => {
    console.error('Failed to load full history:', err);
    document.getElementById('history').innerHTML = '<p style="color:red;">Unable to fetch history.</p>';
  });
}

function loadNotifications() {
  fetch('/rewards/notifications', {
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    const notificationsContainer = document.getElementById('notifications');
    notificationsContainer.innerHTML = '';
    if (data.length === 0) {
      notificationsContainer.innerHTML = '<p style="text-align:center;">No notifications yet.</p>';
      return;
    }
    data.forEach(n => {
      const div = document.createElement('div');
      div.className = 'notification-card';
      div.innerHTML = `
        <div class="notification-icon">üîî</div>
        <div class="notification-content">
          <div class="notification-title">Reward Update</div>
          <div class="notification-message">${n.message}</div>
          <div class="notification-time">${new Date(n.created_at).toLocaleString()}</div>
        </div>
      `;
      notificationsContainer.appendChild(div);
    });
  })
  .catch(err => {
    document.getElementById('notifications').innerHTML = '<p style="color:red;">Unable to fetch notifications.</p>';
  });
}

  loadNotifications();

function cancelFeedback() {
  document.getElementById('send-feedback').style.display = 'none';
  document.getElementById('feedbackMessage').value = '';
  activeOrderId = null;
}




checkForRecentOrders();
  </script>
</body>
</html>
