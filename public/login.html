<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braddex Login</title>
    <link rel="icon" href="images/logo.jpg" type="image/png">
    <link rel="icon" type="image/x-icon" href="images/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="login-signup-styles.css">
    <style>
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
            text-align: left;
        }
        
        .error-message.show {
            display: block;
        }
        
        .input-box.error {
            border-color: #d32f2f;
            background-color: #fff8f8;
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .forgot-password {
            text-align: right;
            margin: 10px 0 20px 0;
            font-size: 14px;
        }
        
        .forgot-password a {
            color: #007bff;
            text-decoration: none;
            transition: color 0.3s ease;
            font-weight: 500;
        }
        
        .forgot-password a:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        
        .forgot-password a:active {
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="image-placeholder">
            <img id="slideshow" src="images/food1.png" alt="Slideshow Image" style="width: 100%; height: 100%; border-radius: 5%;">
        </div>
    </div>

    <div class="right-panel">
        <form class="login-box" id="loginForm">
            <a href="index.html" class="logo"><img src="images/logo.jpg" alt="Logo"></a>
            <h2>Welcome to Braddex</h2>
            <p>Please sign in to access your portal</p>
            
            <!-- Error message container -->
            <div id="errorMessage" class="error-message"></div>
            
            <input type="text" class="input-box" id="loginEmail" placeholder="Email">
            <input type="password" class="input-box" id="loginPassword" placeholder="Password">
            <div id="forgotPasswordLink" class="forgot-password" style="display: none;">
                <a href="#" onclick="handleForgotPassword()">Forgot Password?</a>
            </div>
            <button class="button primary" type="submit" id="loginButton">Login</button>
            <div class="signup">Don't have an account yet? <a href="signup.html">Sign up</a></div>
        </form>
    </div>

    <script>
        // Slideshow logic
        const images = [
            "images/food1.png",
            "images/food2.png",
            "images/food3.png",
            "images/food4.png"
        ];
        let index = 0;
        const slideshow = document.getElementById('slideshow');

        setInterval(() => {
            index = (index + 1) % images.length;
            slideshow.src = images[index];
        }, 3000); 

        // Login redirect logic
        const apiBase = 'http://localhost:51540'; // Change if your server uses a different port

        // Function to show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            
            // Add error styling to input fields
            document.getElementById('loginEmail').classList.add('error');
            document.getElementById('loginPassword').classList.add('error');
            forgotPasswordLink.style.display = 'block';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        // Function to hide error message
        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('show');
            
            // Remove error styling from input fields
            document.getElementById('loginEmail').classList.remove('error');
            document.getElementById('loginPassword').classList.remove('error');
        }

        // Function to show loading state
        function setLoading(loading) {
            const button = document.getElementById('loginButton');
            const form = document.getElementById('loginForm');
            
            if (loading) {
                button.textContent = 'Logging in...';
                button.disabled = true;
                form.classList.add('loading');
            } else {
                button.textContent = 'Login';
                button.disabled = false;
                form.classList.remove('loading');
            }
        }

        // Clear error when user starts typing
        document.getElementById('loginEmail').addEventListener('input', hideError);
        document.getElementById('loginPassword').addEventListener('input', hideError);

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Hide any previous error messages
            hideError();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Basic validation
            if (!email || !password) {
                showError('Please enter both email and password.');
                return;
            }

            // Show loading state
            setLoading(true);

            try {
                const res = await fetch(`${apiBase}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();
                
                if (data.token) {
                    localStorage.setItem('token', data.token); // Save the token
                    console.log(data.user.role);

                    if(data.user.role === 'customer') {
                        window.location.href = '/dashboard/customer';
                    } else if(data.user.role === 'staff') {
                        window.location.href = '/dashboard/staff';
                    } else if(data.user.role === 'admin') {
                        window.location.href = '/dashboard/admin';
                    } else {
                        window.location.href = '/';       // Redirect to dashboard
                    }
                } else {
                    // Handle different types of errors
                    if (data.message) {
                        if (data.message.toLowerCase().includes('not found') || 
                            data.message.toLowerCase().includes('invalid') ||
                            data.message.toLowerCase().includes('incorrect')) {
                            showError('Invalid email or password. Please check your credentials and try again.');
                        } else if (data.message.toLowerCase().includes('not verified') ||
                                   data.message.toLowerCase().includes('unverified')) {
                            showError('Your account is not verified. Please check your email for verification instructions or contact support.');
                        } else if (data.message.toLowerCase().includes('disabled') ||
                                   data.message.toLowerCase().includes('suspended')) {
                            showError('Your account has been disabled. Please contact support for assistance.');
                        } else {
                            showError(data.message);
                        }
                    } else {
                        showError('Login failed. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Network error. Please check your connection and try again.');
            } finally {
                setLoading(false);
            }
        });

        async function handleForgotPassword() {
  const email = document.getElementById('loginEmail').value;

  if (!email) {
    showError('Please enter your email address to reset your password.');
    return;
  }

  try {
    const res = await fetch(`${apiBase}/auth/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    const data = await res.json();
    if (res.ok) {
      alert('Password reset email sent. Please check your inbox.');
    } else {
      showError(data.message || 'Unable to send reset email.');
    }
  } catch (err) {
    console.error(err);
    showError('Network error. Please try again.');
  }
}

    </script>
</body>
</html>
