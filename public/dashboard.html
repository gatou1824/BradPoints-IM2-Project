<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      color: #333;
    }

    header {
      background-color: white; /* changed from red */
      border-bottom: 4px solid #b91c1c; /* red bottom border */
      padding: 20px 330px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header img {
      height: 70px; /* ðŸ‘ˆ limits the logo height */
      object-fit: contain;
    }


    .profile-container {
      position: relative;
      margin-left: 15px;
    }

    .profile-icon {
      width: 70px;
      height: 70px;
      background-color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b91c1c;
      font-weight: bold;
      cursor: pointer;
      font-size: 32px; /* ðŸ‘ˆ this makes the emoji grow */
    }


    .dropdown {
      position: absolute;
      right: 0;
      top: 45px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: none;
      flex-direction: column;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      min-width: 140px; /* ðŸ‘ˆ ensures enough space */
      white-space: nowrap; /* ðŸ‘ˆ prevents text wrapping */
      z-index: 1000;
    }

    .dropdown a {
      padding: 10px 15px;
      color: #b91c1c;
      text-decoration: none;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      display: block;
    }

    .dropdown a:last-child {
      border-bottom: none;
    }

    .dropdown a:hover {
      background-color: #ffeaea;
    }
    #toggle-profile {
      position: fixed;
      top: 134px;
      right: 10px;
      width: 315px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 16px;
      overflow: visible; /* allow avatar to overflow */
      z-index: 999;
      display: none;
      font-family: Arial, sans-serif;
      padding-top: 75px; /* ðŸ‘ˆ add this to make room for avatar */
    }

    .profile-header {
      background-color: #b91c1c;
      color: white;
      text-align: center;
      padding: 40px 20px 20px;
      position: relative;
    }

    .profile-avatar {
      width: 100px; /* â¬† bigger */
      height: 100px; /* â¬† bigger */
      font-size: 42px; /* â¬† bigger emoji */
      top: -50px; /* adjust for larger size */
      border-radius: 50%;
      background-color: #e5e7eb;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #374151;
    }

    .profile-header h2 {
      margin: 10px 0 0;
      font-size: 20px;
    }

    .profile-header span {
      font-size: 13px;
      opacity: 0.9;
    }

    .profile-body {
      padding: 20px;
      font-size: 14px;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 14px;
      padding: 0 10px;
    }

    .profile-label {
      color: #555;
    }

    .profile-value {
      font-weight: bold;
    }

    .customer-inline {
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
      font-size: 14px;
    }

    .customer-inline span {
      min-width: 100px;
      font-weight: bold;
    }

    .customer-inline button {
      padding: 6px 12px;
      font-size: 14px;
      background-color: #dc2626;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    .customer-inline button:hover {
      background-color: #b91c1c;
    }

    main {
      padding: 20px;
      width: 1210px; 
      margin: 0 auto; 
    }


    button {
      background-color: #dc2626;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background-color: #b91c1c;
    }

    input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }

    #order-items div, #foods-list div, #display-all-orders div {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
    }

    #order-items {
      display: none;
      position:absolute;
      top: 138px;
      left: 25px;
      width: 275px;
      min-height: 725px;
      border: 1px solid rgb(204, 204, 204);
      padding: 15px; border-radius: 10px;
      box-shadow: rgba(0, 0, 0, 0.05) 0px 2px 8px;
      background-color: white;
    }

    #foods-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* responsive grid */
      gap: 20px;
    }


    h1, h3 {
      color: #b91c1c;
    }

    #notification-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

.notification {
  background-color: #fef2f2;
  border-left: 5px solid #dc2626;
  padding: 12px 16px;
  margin-bottom: 10px;
  border-radius: 6px;
  color: #7f1d1d;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  min-width: 220px;
  max-width: 300px;
  animation: fadeInOut 4s forwards;
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(-10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-10px); }
}

  </style>
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('No token found. Redirecting...');
      window.location.href = '/';
    }

    fetch('/profile', {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error('Unauthorized');
      return res.json();
    })
    .then(data => {
      if (data.role !== 'staff' && data.role !== 'admin') {
        window.location.href = '/dashboard/customer';
      }
    })
    .catch(err => {
      alert('Access denied or token invalid. Redirecting...');
      window.location.href = '/';
    });


    document.addEventListener('DOMContentLoaded', () => {
      const profileDropdown = document.getElementById('profileDropdown');
      const profileIcon = document.getElementById('profileIcon');

      profileIcon.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent triggering global click
        // Hide profile card if open
        toggleProfile.style.display = 'none';
        profileVisible = false;

        // Toggle dropdown
        profileDropdown.style.display = profileDropdown.style.display === 'flex' ? 'none' : 'flex';
      });
    });

  </script>
</head>
<body>

  <header>
    <img src="images/logo.jpg" alt="">
    <div class="profile-container">
      <div class="profile-icon" id="profileIcon">ðŸ‘¤</div>
      <div class="dropdown" id="profileDropdown">
        <a href="#" onclick="profile()">View Profile</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </header>

  <div id="notification-container"></div>

<!-- LEFT: Order Items -->
<div id="order-items">
  <h3>Selected Items:</h3>
  <p>No items selected yet.</p>
</div>

<main>
    <div id="toggle-profile"></div>


    <!-- RIGHT: Form + Foods + Buttons -->
    <div style="flex: 1;">
      <form id="customerForm">
        <input type="text" id="customerCodeInput" placeholder="Enter customer code" required />
        <button type="submit">Check Customer</button>
      </form>

      <div id="customer-order-confirmation"></div>

<div id="order-functions" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
      <div id="reward-code-container" style="display: none;">
        <input type="text" id="rewardCodeInput" placeholder="Enter reward code (optional)" />
        <button type="button" id="claimRewardBtn">Claim Code</button> <!-- New button -->
      </div>


        <button id="placeOrderBtn" style="display: none;">Place Order</button>
        <button id="cancelOrderBtn" style="display: none; background-color: gray;">Cancel Order</button>
      </div>


      <div id="foods-list" style="display: none; margin-top: 20px;"></div>
      <div id="display-all-orders" style="margin-top: 30px;"></div>
    </div>
</main>


<script>
  const foodsList = document.getElementById('foods-list');
  const toggleProfile = document.getElementById('toggle-profile');
  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const rewardCodeInput = document.getElementById('rewardCodeInput');
  const cancelOrderBtn = document.getElementById('cancelOrderBtn');

  let profileVisible = false;
  let selectedFoods = [];
  rewardCodeInput.value = '';
  let currentCustomer = null;

  function logout() {
    localStorage.removeItem('token');
    window.location.href = '/';
  }

  function profile() {
    document.getElementById('profileDropdown').style.display = 'none';
    fetch('/profile', {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
      toggleProfile.innerHTML = `
        <div class="profile-header">
          <div class="profile-avatar">ðŸ‘¤</div>
          <h2>${data.username}</h2>
          <span>${data.user_code}</span>
        </div>
        <div class="profile-body">
          <div class="profile-row">
            <span class="profile-label">Email</span>
            <span class="profile-value">${data.email}</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Role</span>
            <span class="profile-value">${data.role}</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Points</span>
            <span class="profile-value">${data.points}</span>
          </div>
        </div>
      `;
      toggleProfile.style.display = 'block';
      profileVisible = true;
    })
    .catch(() => {
      alert('Token invalid. Redirecting...');
      window.location.href = '/';
    });
  }


  function addToOrder(foodId) {
    const existing = selectedFoods.find(f => f.id === foodId);
    if (existing) {
      existing.quantity += 1;
    } else {
      const food = allFoods.find(f => f.id === foodId);
      if (!food) return;
      selectedFoods.push({
        id: foodId,
        name: food.name,
        quantity: 1
      });
    }
    renderOrderItems();
  }
function renderOrderItems() {
  const orderItemsDiv = document.getElementById('order-items');
  orderItemsDiv.innerHTML = '<h3>Selected Items:</h3>';

  if (selectedFoods.length === 0) {
    orderItemsDiv.innerHTML += '<p>No items selected yet.</p>';
    return;
  }

  let totalPrice = 0;
  let totalPoints = 0;

  selectedFoods.forEach(item => {
    const foodData = allFoods.find(f => f.id === item.id);
    const price = foodData?.price || 0;
    const points = foodData?.points || 0;
    let rewardTag = '';
    if (item.isReward) {
      const rewardPoints = foodData?.points || 0;
      rewardTag = ` <span style="color: green; font-weight: bold;">(Redeemed for ${rewardPoints} pts)</span>`;
    }

    // Only count non-reward item price/points in total
    if (!item.isReward) {
      totalPrice += price * item.quantity;
      totalPoints += points * item.quantity;
    }

    const itemDiv = document.createElement('div');
    itemDiv.style.borderBottom = '1px solid #ccc';
    itemDiv.style.padding = '5px';
    itemDiv.style.marginTop = '5px';

    itemDiv.innerHTML = `
      <p>
        ${item.name}${rewardTag} | 
        Quantity: ${item.quantity} |
        Price: â‚±${price} |
        Points: ${points}
      </p>
    `;
    orderItemsDiv.appendChild(itemDiv);
  });

  // Total row
  const totalDiv = document.createElement('div');
  totalDiv.style.marginTop = '15px';
  totalDiv.style.borderTop = '2px solid #ccc';
  totalDiv.style.paddingTop = '10px';
  totalDiv.style.fontWeight = 'bold';
  totalDiv.innerHTML = `
    <p>Total Price: â‚±${totalPrice.toFixed(2)}</p>
    <p>Total Points: ${totalPoints}</p>
  `;

  let totalRewardPoints = selectedFoods
  .filter(item => item.isReward)
  .reduce((sum, item) => {
    const food = allFoods.find(f => f.id === item.id);
    return sum + (food?.points || 0) * item.quantity;
  }, 0);

  if (totalRewardPoints > 0) {
    const rewardPointsDiv = document.createElement('div');
    rewardPointsDiv.style.marginTop = '10px';
    rewardPointsDiv.innerHTML = `
      <p style="color: #16a34a;"><strong>Points Deducted for Rewards:</strong> ${totalRewardPoints}</p>
    `;
    orderItemsDiv.appendChild(rewardPointsDiv);
  }


  orderItemsDiv.appendChild(totalDiv);
}



function confirmUser() {
  if (currentCustomer) {
    foodsList.style.display = 'grid';
    placeOrderBtn.style.display = 'block';
    cancelOrderBtn.style.display = 'inline-block';
    document.getElementById('display-all-orders').style.display = 'none';
    document.getElementById('reward-code-container').style.display = 'block';
    document.getElementById('order-items').style.display = 'block';

    const btn = document.getElementById('confirmBtn');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Confirmed';
      btn.style.opacity = 0.5;
      btn.style.cursor = 'default';
    }
  }
}



  fetch('/foods', {
    method: 'GET',
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => res.json())
  .then(data => {
    allFoods = data;
    foodsList.innerHTML = '';
    data.forEach(food => {
      const item = document.createElement('div');
      item.style.border = '1px solid #ccc';
      item.style.padding = '15px';
      item.style.borderRadius = '10px';
      item.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
      item.style.backgroundColor = 'white';

      item.innerHTML = `
        <h3>${food.name}</h3>
        <p>Description: ${food.description}</p>
        <p>Price: â‚±${food.price}</p>
        <p>Points: ${food.points}</p>
        <button onclick="addToOrder(${food.id})">Add to Order</button>
      `;
      foodsList.appendChild(item);
    });
  });

  document.getElementById('customerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const customerCode = document.getElementById('customerCodeInput').value;
    fetch(`/customers/${customerCode}`, {
      method: 'GET',
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
      currentCustomer = data;
      selectedFoods = [];
document.getElementById('customer-order-confirmation').innerHTML = `
  <div class="customer-inline">
    <div>
      <div style="font-size: 12px; color: #888;">Username</div>
      <span>${data.username}</span>
    </div>
    <div>
      <div style="font-size: 12px; color: #888;">Code</div>
      <span>${data.user_code}</span>
    </div>
    <div>
      <div style="font-size: 12px; color: #888;">Points</div>
      <span>${data.points}</span>
    </div>
    <button id="confirmBtn" onclick="confirmUser()">Confirm</button>

  </div>
`;


    })
    .catch(() => {
      alert('Customer not found!');
      currentCustomer = null;
      selectedFoods = [];
      foodsList.style.display = 'none';
      placeOrderBtn.style.display = 'none';
      document.getElementById('customer-order-confirmation').innerHTML = '';
      document.getElementById('reward-code-container').style.display = 'none';
    });
  });

function addRewardItemFromCode(code) {
  if (!code) {
    showNotification('Please enter a reward code.');
    return;
  }

  fetch(`/rewards/validate/${code}`, {
    method: 'GET',
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(err => {
        throw new Error(err.message || 'Unknown error');
      });
    }
    return res.json();
  })
  .then(data => {
    const alreadyExists = selectedFoods.find(item => item.id === data.food.id && item.isReward);
    if (alreadyExists) {
      alert('Reward already claimed.');
      return;
    }

    selectedFoods.push({
      id: data.food.id,
      name: data.food.name,
      quantity: 1,
      isReward: true
    });

    rewardCodeInput.value = ''; // clear field
    renderOrderItems();
    showNotification(`Reward "${data.food.name}" added successfully!`);

  })
  .catch((err) => {
    showNotification(err.message); // âœ… Replaces alert
    console.error(err);
  });
}

document.getElementById('claimRewardBtn').addEventListener('click', () => {
  const code = rewardCodeInput.value.trim();
  addRewardItemFromCode(code);
});


placeOrderBtn.addEventListener('click', () => {
    const rewardCode = rewardCodeInput.value.trim();
    if (rewardCode !== '') addRewardItemFromCode(rewardCode);
    if (!currentCustomer) {
      alert('No customer selected.');
      return;
    }
    if (selectedFoods.length === 0 && rewardCode === '') {
      alert('No food items selected and no reward code entered.');
      return;
    }
    const payload = {
      customer_id: currentCustomer.id,
      food_ids: selectedFoods,
      reward_code: rewardCode !== '' ? rewardCode : undefined
    };
    fetch('/orders/confirm', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (!res.ok) throw new Error('Order failed');
      return res.json();
    })
    .then(() => {
      alert('Order successfully placed! âœ…');
      selectedFoods = [];
      placeOrderBtn.style.display = 'none';
      foodsList.style.display = 'none';
      cancelOrderBtn.style.display = 'none';
      document.getElementById('customer-order-confirmation').innerHTML = '';
      document.getElementById('customerCodeInput').value = '';
      rewardCodeInput.value = '';
      document.getElementById('reward-code-container').style.display = 'none';
      document.getElementById('order-items').style.display = 'none';
      loadTodayOrders();
      document.getElementById('display-all-orders').style.display = 'block';
    });
  });

  function loadTodayOrders() {
    fetch('/orders/today', {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('display-all-orders');
      container.innerHTML = '<h3>Today\'s Orders</h3>';
      if (data.length === 0) {
        container.innerHTML += '<p>No orders today.</p>';
        return;
      }
      data.forEach(order => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.marginBottom = '10px';
        div.style.padding = '10px';
        div.innerHTML = `
          <p><strong>Order ID:</strong> ${order.id}</p>
          <p><strong>Customer:</strong> ${order.customer_name || 'N/A'}</p>
          <p><strong>Time:</strong> ${new Date(order.created_at).toLocaleTimeString()}</p>
          <button onclick="viewOrderDetails(${order.id})">Order Details</button>
          <div id="order-details-${order.id}" style="display: none; margin-top: 10px;"></div>

          <hr />
        `;
        container.appendChild(div);
      });
    })
    .catch(err => {
      console.error('Error loading today\'s orders:', err);
    });
  }

  document.addEventListener('click', function (event) {
    const profileCard = document.getElementById('toggle-profile');
    const profileIcon = document.getElementById('profileIcon');
    const profileDropdown = document.getElementById('profileDropdown');

    // Hide profile card if visible and clicked outside
    if (profileVisible && !profileCard.contains(event.target) && !profileIcon.contains(event.target)) {
      profileCard.style.display = 'none';
      profileVisible = false;
    }

    // Hide dropdown if clicked outside
    if (!profileDropdown.contains(event.target) && !profileIcon.contains(event.target)) {
      profileDropdown.style.display = 'none';
    }
  });

  cancelOrderBtn.addEventListener('click', () => {
  selectedFoods = [];
  currentCustomer = null;
  rewardCodeInput.value = '';

  foodsList.style.display = 'none';
  placeOrderBtn.style.display = 'none';
  cancelOrderBtn.style.display = 'none';
  document.getElementById('customerCodeInput').value = '';
  document.getElementById('customer-order-confirmation').innerHTML = '';
  document.getElementById('reward-code-container').style.display = 'none';
  document.getElementById('order-items').style.display = 'none'
    document.getElementById('order-items').innerHTML = '<h3>Selected Items:</h3><p>No items selected yet.</p>';  
  document.getElementById('display-all-orders').style.display = 'block';

  });

  function viewOrderDetails(orderId) {
  const container = document.getElementById(`order-details-${orderId}`);
  if (container.style.display === 'block') {
    container.style.display = 'none';
    container.innerHTML = '';
    return;
  }

  fetch(`/orders/${orderId}/details`, {
    method: 'GET',
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.length === 0) {
      container.innerHTML = '<p>No items found.</p>';
    } else {
      container.innerHTML = '<ul>' + data.map(item => 
        `<li>${item.name} - Quantity: ${item.quantity}</li>`
      ).join('') + '</ul>';
    }
    container.style.display = 'block';
  })
  .catch(err => {
    console.error('Error fetching order details:', err);
    container.innerHTML = '<p>Error loading order details.</p>';
    container.style.display = 'block';
  });
}

function showNotification(message) {
  const container = document.getElementById('notification-container');
  const notif = document.createElement('div');
  notif.className = 'notification';
  notif.innerText = message;

  container.appendChild(notif);

  // Auto-remove after animation
  setTimeout(() => {
    notif.remove();
  }, 4000);
}


  loadTodayOrders();
</script>

</body>
</html>
